#include "modify_Hilbert3D.h"
#include "stdio.h"
#include "stdlib.h"
#include "math.h"

//最大的立方体
int **cube(int lev0, int level)
{
	int H3L1[8][3] = { 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0 };
	int H3L2[64][3] = { 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 2, 0, 0, 3, 0, 1, 3, 0, 1, 2, 1, 1, 2, 1, 1, 3, 1, 0,
		3, 1, 0, 2, 2, 0, 2, 2, 0, 3, 2, 1, 3, 2, 1, 2, 3, 1, 2, 3, 1, 3, 3, 0, 3, 3, 0, 2, 3, 0, 1, 3, 0, 0, 2, 0, 0, 2, 0, 1, 2, 1, 1, 2, 1, 0, 3, 1, 0,
		3, 1, 1, 3, 2, 1, 3, 2, 0, 2, 2, 0, 2, 2, 1, 2, 3, 1, 2, 3, 0, 3, 3, 0, 3, 3, 1, 3, 3, 2, 3, 3, 3, 3, 2, 3, 3, 2, 2, 2, 2, 2, 2, 2, 3, 2, 3, 3, 2,
		3, 2, 1, 3, 2, 1, 3, 3, 1, 2, 3, 1, 2, 2, 0, 2, 2, 0, 2, 3, 0, 3, 3, 0, 3, 2, 0, 3, 1, 0, 2, 1, 1, 2, 1, 1, 3, 1, 1, 3, 0, 1, 2, 0, 0, 2, 0, 0, 3, 0 };
	int H3L3[512][3] = { 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 2, 0, 0, 3, 0, 0, 3, 1, 0, 2, 1, 1, 2, 1, 1, 3, 1, 1, 3,
		0, 1, 2, 0, 2, 2, 0, 2, 3, 0, 2, 3, 1, 2, 2, 1, 3, 2, 1, 3, 3, 1, 3, 3, 0, 3, 2, 0, 3, 1, 0, 3, 0, 0, 2, 0, 0, 2, 1, 0, 2, 1, 1, 2, 0, 1, 3, 0, 1, 3,
		1, 1, 3, 1, 2, 3, 0, 2, 2, 0, 2, 2, 1, 2, 2, 1, 3, 2, 0, 3, 3, 0, 3, 3, 1, 3, 3, 2, 3, 3, 3, 3, 3, 3, 2, 3, 2, 2, 2, 2, 2, 2, 3, 2, 2, 3, 3, 2, 2, 3,
		1, 2, 3, 1, 3, 3, 1, 3, 2, 1, 2, 2, 0, 2, 2, 0, 3, 2, 0, 3, 3, 0, 2, 3, 0, 1, 3, 0, 1, 2, 1, 1, 2, 1, 1, 3, 1, 0, 3, 1, 0, 2, 0, 0, 2, 0, 0, 3, 0, 0,
		4, 1, 0, 4, 1, 1, 4, 0, 1, 4, 0, 1, 5, 1, 1, 5, 1, 0, 5, 0, 0, 5, 0, 0, 6, 0, 0, 7, 1, 0, 7, 1, 0, 6, 1, 1, 6, 1, 1, 7, 0, 1, 7, 0, 1, 6, 0, 2, 6, 0,
		2, 7, 1, 2, 7, 1, 2, 6, 1, 3, 6, 1, 3, 7, 0, 3, 7, 0, 3, 6, 0, 3, 5, 0, 3, 4, 0, 2, 4, 0, 2, 5, 1, 2, 5, 1, 2, 4, 1, 3, 4, 1, 3, 5, 2, 3, 5, 2, 3, 4,
		2, 2, 4, 2, 2, 5, 3, 2, 5, 3, 2, 4, 3, 3, 4, 3, 3, 5, 3, 3, 6, 3, 3, 7, 2, 3, 7, 2, 3, 6, 2, 2, 6, 2, 2, 7, 3, 2, 7, 3, 2, 6, 3, 1, 6, 3, 1, 7, 2, 1,
		7, 2, 1, 6, 2, 0, 6, 2, 0, 7, 3, 0, 7, 3, 0, 6, 3, 0, 5, 2, 0, 5, 2, 1, 5, 3, 1, 5, 3, 1, 4, 2, 1, 4, 2, 0, 4, 3, 0, 4, 4, 0, 4, 5, 0, 4, 5, 1, 4, 4,
		1, 4, 4, 1, 5, 5, 1, 5, 5, 0, 5, 4, 0, 5, 4, 0, 6, 4, 0, 7, 5, 0, 7, 5, 0, 6, 5, 1, 6, 5, 1, 7, 4, 1, 7, 4, 1, 6, 4, 2, 6, 4, 2, 7, 5, 2, 7, 5, 2, 6,
		5, 3, 6, 5, 3, 7, 4, 3, 7, 4, 3, 6, 4, 3, 5, 4, 3, 4, 4, 2, 4, 4, 2, 5, 5, 2, 5, 5, 2, 4, 5, 3, 4, 5, 3, 5, 6, 3, 5, 6, 3, 4, 6, 2, 4, 6, 2, 5, 7, 2,
		5, 7, 2, 4, 7, 3, 4, 7, 3, 5, 7, 3, 6, 7, 3, 7, 6, 3, 7, 6, 3, 6, 6, 2, 6, 6, 2, 7, 7, 2, 7, 7, 2, 6, 7, 1, 6, 7, 1, 7, 6, 1, 7, 6, 1, 6, 6, 0, 6, 6,
		0, 7, 7, 0, 7, 7, 0, 6, 7, 0, 5, 6, 0, 5, 6, 1, 5, 7, 1, 5, 7, 1, 4, 6, 1, 4, 6, 0, 4, 7, 0, 4, 7, 0, 3, 7, 1, 3, 6, 1, 3, 6, 0, 3, 6, 0, 2, 6, 1, 2,
		7, 1, 2, 7, 0, 2, 7, 0, 1, 7, 0, 0, 7, 1, 0, 7, 1, 1, 6, 1, 1, 6, 1, 0, 6, 0, 0, 6, 0, 1, 5, 0, 1, 5, 0, 0, 5, 1, 0, 5, 1, 1, 4, 1, 1, 4, 1, 0, 4, 0,
		0, 4, 0, 1, 4, 0, 2, 4, 0, 3, 5, 0, 3, 5, 0, 2, 5, 1, 2, 5, 1, 3, 4, 1, 3, 4, 1, 2, 4, 2, 2, 4, 2, 3, 5, 2, 3, 5, 2, 2, 5, 3, 2, 5, 3, 3, 4, 3, 3, 4,
		3, 2, 4, 3, 1, 4, 3, 0, 4, 2, 0, 4, 2, 1, 5, 2, 1, 5, 2, 0, 5, 3, 0, 5, 3, 1, 6, 3, 1, 6, 3, 0, 6, 2, 0, 6, 2, 1, 7, 2, 1, 7, 2, 0, 7, 3, 0, 7, 3, 1,
		7, 3, 2, 7, 2, 2, 6, 2, 2, 6, 3, 2, 6, 3, 3, 6, 2, 3, 7, 2, 3, 7, 3, 3, 7, 4, 3, 7, 5, 3, 6, 5, 3, 6, 4, 3, 6, 4, 2, 6, 5, 2, 7, 5, 2, 7, 4, 2, 7, 4,
		1, 7, 4, 0, 7, 5, 0, 7, 5, 1, 6, 5, 1, 6, 5, 0, 6, 4, 0, 6, 4, 1, 5, 4, 1, 5, 4, 0, 5, 5, 0, 5, 5, 1, 4, 5, 1, 4, 5, 0, 4, 4, 0, 4, 4, 1, 4, 4, 2, 4,
		4, 3, 5, 4, 3, 5, 4, 2, 5, 5, 2, 5, 5, 3, 4, 5, 3, 4, 5, 2, 4, 6, 2, 4, 6, 3, 5, 6, 3, 5, 6, 2, 5, 7, 2, 5, 7, 3, 4, 7, 3, 4, 7, 2, 4, 7, 1, 4, 7, 0,
		4, 6, 0, 4, 6, 1, 5, 6, 1, 5, 6, 0, 5, 7, 0, 5, 7, 1, 6, 7, 1, 6, 7, 0, 6, 6, 0, 6, 6, 1, 7, 6, 1, 7, 6, 0, 7, 7, 0, 7, 7, 1, 7, 7, 2, 7, 6, 2, 6, 6,
		2, 6, 7, 2, 6, 7, 3, 6, 6, 3, 7, 6, 3, 7, 7, 3, 7, 7, 4, 6, 7, 4, 6, 6, 4, 7, 6, 4, 7, 6, 5, 6, 6, 5, 6, 7, 5, 7, 7, 5, 7, 7, 6, 7, 7, 7, 6, 7, 7, 6,
		7, 6, 6, 6, 6, 6, 6, 7, 7, 6, 7, 7, 6, 6, 7, 5, 6, 7, 5, 7, 6, 5, 7, 6, 5, 6, 6, 4, 6, 6, 4, 7, 7, 4, 7, 7, 4, 6, 7, 4, 5, 7, 4, 4, 7, 5, 4, 7, 5, 5,
		6, 5, 5, 6, 5, 4, 6, 4, 4, 6, 4, 5, 5, 4, 5, 5, 4, 4, 5, 5, 4, 5, 5, 5, 4, 5, 5, 4, 5, 4, 4, 4, 4, 4, 4, 5, 4, 4, 6, 4, 4, 7, 5, 4, 7, 5, 4, 6, 5, 5,
		6, 5, 5, 7, 4, 5, 7, 4, 5, 6, 4, 6, 6, 4, 6, 7, 5, 6, 7, 5, 6, 6, 5, 7, 6, 5, 7, 7, 4, 7, 7, 4, 7, 6, 4, 7, 5, 5, 7, 5, 5, 6, 5, 4, 6, 5, 4, 6, 4, 5,
		6, 4, 5, 7, 4, 4, 7, 4, 3, 7, 4, 2, 7, 4, 2, 6, 4, 3, 6, 4, 3, 6, 5, 2, 6, 5, 2, 7, 5, 3, 7, 5, 3, 7, 6, 3, 7, 7, 2, 7, 7, 2, 7, 6, 2, 6, 6, 2, 6, 7,
		3, 6, 7, 3, 6, 6, 3, 5, 6, 3, 5, 7, 2, 5, 7, 2, 5, 6, 2, 4, 6, 2, 4, 7, 3, 4, 7, 3, 4, 6, 3, 4, 5, 3, 4, 4, 3, 5, 4, 3, 5, 5, 2, 5, 5, 2, 5, 4, 2, 4,
		4, 2, 4, 5, 1, 4, 5, 1, 4, 4, 1, 5, 4, 1, 5, 5, 0, 5, 5, 0, 5, 4, 0, 4, 4, 0, 4, 5, 0, 4, 6, 0, 4, 7, 1, 4, 7, 1, 4, 6, 1, 5, 6, 1, 5, 7, 0, 5, 7, 0,
		5, 6, 0, 6, 6, 0, 6, 7, 1, 6, 7, 1, 6, 6, 1, 7, 6, 1, 7, 7, 0, 7, 7, 0, 7, 6, 0, 7, 5, 1, 7, 5, 1, 6, 5, 0, 6, 5, 0, 6, 4, 1, 6, 4, 1, 7, 4, 0, 7, 4,
		0, 7, 3, 0, 7, 2, 1, 7, 2, 1, 7, 3, 1, 6, 3, 1, 6, 2, 0, 6, 2, 0, 6, 3, 0, 5, 3, 0, 4, 3, 0, 4, 2, 0, 5, 2, 1, 5, 2, 1, 4, 2, 1, 4, 3, 1, 5, 3, 2, 5,
		3, 2, 4, 3, 2, 4, 2, 2, 5, 2, 3, 5, 2, 3, 4, 2, 3, 4, 3, 3, 5, 3, 3, 6, 3, 3, 7, 3, 2, 7, 3, 2, 6, 3, 2, 6, 2, 2, 7, 2, 3, 7, 2, 3, 6, 2, 3, 6, 1, 3,
		7, 1, 2, 7, 1, 2, 6, 1, 2, 6, 0, 2, 7, 0, 3, 7, 0, 3, 6, 0, 3, 5, 0, 3, 4, 0, 3, 4, 1, 3, 5, 1, 2, 5, 1, 2, 4, 1, 2, 4, 0, 2, 5, 0, 1, 5, 0, 1, 4, 0,
		1, 4, 1, 1, 5, 1, 0, 5, 1, 0, 4, 1, 0, 4, 0, 0, 5, 0, 0, 6, 0, 0, 6, 1, 1, 6, 1, 1, 6, 0, 1, 7, 0, 1, 7, 1, 0, 7, 1, 0, 7, 0 };
	int i, j;
	int **m0;
	for (i = 0; i < 8;i++)
	for (j = 0; j < 3; j++)
		H3L1[i][j] = H3L1[i][j];
	for (i = 0; i < 64; i++)
	for (j = 0; j < 3; j++)
		H3L2[i][j] = H3L2[i][j];
	for (i = 0; i < 512; i++)
	for (j = 0; j < 3; j++)
		H3L3[i][j] = H3L3[i][j];
	if (lev0 < level){
		int lev, p, q;  
		int k = pow(2, (lev0 * 3));
		int k1 = pow(2, 2 * level + 3);
		int k2, k2_4;
		short int **m = create_arr0(3, k1);
		m0 = create_arr0(3, k1);
		for (i = 0; i < k; i++)
		for (j = 0; j < 3; j++){
			if (lev0 == 1)
				m0[j][i] = H3L1[i][j];
			else if (lev0 == 2)
				m0[j][i] = H3L2[i][j];
			else
				m0[j][i] = H3L3[i][j];
		}
		q = m0[0][0];
		for (i = 0; i < k; i++)
		for (j = 0; j < 3; j++)
		if (m0[j][i]>q)
			q = m0[j][i];
		k2 = k * 4;
		for (lev = lev0 + 1; lev <= level; lev++){
			p = pow(2, (lev - 1));
			k2_4 = k2 / 4;
			for (i = 0; i < k2; i++)               
			for (j = 0; j < 3; j++){
				if (i >= 0 && i < k2_4){
					m[0][i] = m0[0][i];
					m[1][i] = m0[2][i];
					m[2][i] = m0[1][i];
				}
				else if (i >= k2_4 && i < 2 * k2_4){
					m[0][i] = m0[0][i - k2_4];
					m[1][i] = m0[1][i - k2_4];
					m[2][i] = m0[2][i - k2_4] + p;
				}
				else if (i >= 2 * k2_4 && i < 3 * k2_4){
					m[0][i] = m0[0][i - 2 * k2_4];
					m[1][i] = m0[1][i - 2 * k2_4] + p;
					m[2][i] = m0[2][i - 2 * k2_4] + p;
				}
				else{
					m[0][i] = m0[0][i - 3 * k2_4];
					m[1][i] = q - m0[2][i - 3 * k2_4] + p;
					m[2][i] = q - m0[1][i - 3 * k2_4];
				}
			}
			for (i = 0; i < k2; i++){
					m0[0][i] = m[0][i];
					m0[1][i] = m[1][i];
					m0[2][i] = m[2][i];
				}
				q = 2 * p - 1;
				k2 = k2 * 4;
		}
		for (i = 0; i < 3; i++)
			free(m[i]);
		free(m);
		return m0;
	}
	else{
		m0 = create_arr0(3, pow(2, lev0 * 3));
		switch (lev0){
		case 1:
			for (i = 0; i < 8; i++)
			for (j = 0; j < 3; j++)
				m0[j][i] = H3L1[i][j];
			break;
		case 2:
			for (i = 0; i < 64; i++)
			for (j = 0; j < 3; j++)
				m0[j][i] = H3L2[i][j];
			break;
		case 3:
			for (i = 0; i < 512; i++)
			for (j = 0; j < 3; j++)
				m0[j][i] = H3L3[i][j];
			break;
		default:
			break;
		}
		return m0;
	}
}
int st0[1024];

//传递基本square的长度width,总的高度height，还有h要加的序列，返回一个加完的二维数组
int **modifyHilbert3D_BlockDeformation0(int rank, int wi, int high)
{
	int i, j;
	int k2 = pow(2, wi * 2 + rank);
	int **m0;
	int *t1;
	int d0 = pow(2, rank);
	int H0, dic, dim, delH, subdim, nsub;
	int *inc = row0(13), *inc0 = row0(13);
	block0 delH_block;
	int len_inc;
	int g = 0, l = 0;

	L = 1;
	nsubtem = 1;
	m0 = cube(rank, wi);
	for (i = 0; i < k2;i++)
	for (j = 0; j < 3; j++)
		m0[j][i] = m0[j][i] + 1;
	if (wi > rank){
		t1 = row0(k2);
		for (j = 0; j < k2; j++){
			t1[j] = m0[0][j];
			m0[0][j] = m0[2][j];
			m0[2][j] = t1[j];
		}                                 //m0一三两行交换 
		free(t1);
	}
	H0 = ((high + d0 - 1) / d0) * d0;    //比hight大的最小单元
	dic = high - H0;
	dim = m0[0][0];
	for (i = 0; i < 3; i++)
	for (j = 0; j < k2; j++)
	if (dim < m0[i][j]) dim = m0[i][j];
	delH = H0 - dim;
	if (delH != 0){
		delH_block = find_basic_block0(abs(delH));
		for (i = 0; i < delH_block.num; i++){
			inc[i] = Sign(delH)*delH_block.block[i];
			delH_block.block[i] = inc[i];
		}
		if (delH_block.num >= 3){
			for (i = 0; i < delH_block.num; i++)
				inc0[i] = inc[i];
			j = delH_block.num;
			delH_block = find_2s_inc0(dim, delH, delH_block);  //matlab-----inc
			for (i = 0; i < delH_block.num; i++)    
				inc[i] = delH_block.block[i];
			len_inc = delH_block.num;
			if (delH_block.block[0] + dim <= 0){
				for (i = 0; i < j; i++)
					inc[i] = inc0[i];
				len_inc = j;
				delH_block.num = len_inc;
			}
		}
		N0 = dim*dim*pow(2, rank); Nsub = N0;
		subdim = abs(inc[0]) * 2;
		nsub = (dim + subdim - 1) / subdim;   //the number of sub-squares that needs to be stretched.
		for (i = 0; i < nsub; i++)
			st0[i] = 1;
		for (i = 0; i < delH_block.num; i++){
			m0 = modify_Hilbert3D_sub(dim, inc[i], m0, rank, st0);  
			L++;	
		}
	}
	else{
		nsub = dim / pow(2, rank);
		N0 = pow(pow(2, wi), 2)*pow(2, rank);
		Nsub = N0;
		for (i = 0; i < nsub; i++)
			st0[i] = 1;
	}
	if (dic != 0){
		N0 = dim*H0*pow(2, rank);
		m0 = modify_Hilbert3D_sub3D(wi, high, dim, dic, m0, N0, Nsub, st0, rank);  
	}
	free(inc); free(inc0);
	return m0;
}